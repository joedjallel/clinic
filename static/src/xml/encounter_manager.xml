<?xml version="1.0" encoding="UTF-8"?>
<templates>
  <t t-name="clinic.EncounterManagerTemplate">
    <div class="o_doc_encounter">

      <!-- Error State -->
      <t t-if="state.error">
        <div class="alert alert-danger">
          <strong>Error:</strong> <t t-esc="state.error"/>
        </div>
      </t>

      <!-- Loading State -->
      <t t-elif="state.loading">
        <div class="alert alert-info">
          <i class="fa fa-spinner fa-spin"></i> Chargement...
        </div>
      </t>

      <!-- No Encounter -->
      <t t-elif="!state.encounterId">
        <div class="alert alert-warning">
          Aucune consultation en cours pour vous aujourd'hui.
        </div>
      </t>

      <!-- Main Content -->
      <t t-else="">
        <!-- Patient Info -->
        <div class="patient-card mb-3">
          <h4>Patient: <t t-esc="state.patient.name or 'N/A'"/></h4>
          <div class="row">
            <div class="col-md-3">
              <strong>Âge:</strong> <t t-esc="state.patient.age or 'N/A'"/>
            </div>
            <div class="col-md-3">
              <strong>Genre:</strong> <t t-esc="state.patient.gender or 'N/A'"/>
            </div>
            <div class="col-md-3">
              <strong>Téléphone:</strong> <t t-esc="state.patient.phone or 'N/A'"/>
            </div>

          </div>
        </div>

        <!-- Encounter Info -->
        <div class="encounter-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Consultation #<t t-esc="state.encounter.name or 'N/A'"/></span>
            <button class="btn btn-sm"
                    t-att-class="getStatusClass(state.encounter.state)"
                    t-on-click="toggleStatus">
              <t t-esc="getStatusLabel(state.encounter.state)"/>
            </button>
          </div>

          <div class="card-body">
            <!-- Chief Complaint -->
            <div class="form-group mb-3">
              <label class="form-label">Motif principal</label>
              <textarea class="form-control"
                        rows="3"
                        t-model="state.encounter.chief_complaint"
                        t-on-blur="() => this.saveField('chief_complaint')"
                        placeholder="Décrivez le motif de consultation..."/>
            </div>

            <!-- Diagnosis -->
            <div class="form-group mb-3">
              <label class="form-label">Diagnostic</label>
              <textarea class="form-control"
                        rows="3"
                        t-model="state.encounter.diagnosis"
                        t-on-blur="() => this.saveField('diagnosis')"
                        placeholder="Diagnostic principal et différentiels..."/>
            </div>

            <!-- Treatment Plan -->
            <div class="form-group mb-3">
              <label class="form-label">Plan thérapeutique</label>
              <textarea class="form-control"
                        rows="3"
                        t-model="state.encounter.treatment_plan"
                        t-on-blur="() => this.saveField('treatment_plan')"
                        placeholder="Plan de traitement recommandé..."/>
            </div>

            <!-- Follow Up -->
            <div class="form-group mb-3">
              <label class="form-label">Suivi recommandé</label>
              <textarea class="form-control"
                        rows="3"
                        t-model="state.encounter.follow_up"
                        t-on-blur="() => this.saveField('follow_up')"
                        placeholder="Instructions de suivi..."/>
            </div>

            <!-- Observations Section -->
            <div class="form-group mb-3">
              <label class="form-label">Observations</label>
              <div class="observations-list">
                <t t-foreach="state.observations" t-as="obs" t-key="obs.id">
                  <div class="d-flex gap-2 mb-2">
                    <input type="text"
                           class="form-control"
                           t-model="obs.code"
                           placeholder="Code LOINC"/>
                    <input type="number"
                           class="form-control"
                           t-model="obs.value_float"
                           step="0.1"
                           placeholder="Valeur"/>
                    <input type="text"
                           class="form-control"
                           t-model="obs.value_unit"
                           placeholder="Unité"/>
                    <button type="button"
                            class="btn btn-outline-danger"
                            t-on-click="() => this.removeObs(obs.id)">
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                </t>
                <button type="button"
                        class="btn btn-outline-primary btn-sm"
                        t-on-click="addObs">
                  <i class="fa fa-plus"></i> Ajouter observation
                </button>
              </div>
            </div>

            <!-- Prescriptions Section -->
            <div class="form-group mb-3">
              <label class="form-label">Prescriptions</label>
              <div class="prescriptions-list">
                <t t-foreach="state.prescriptions" t-as="rx" t-key="rx.id">
                  <div class="d-flex gap-2 mb-2">
                    <input type="text"
                           class="form-control"
                           t-model="rx.name"
                           placeholder="Nom du médicament"/>
                    <button type="button"
                            class="btn btn-outline-danger"
                            t-on-click="() => this.removeRx(rx.id)">
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                </t>
                <button type="button"
                        class="btn btn-outline-primary btn-sm"
                        t-on-click="addRx">
                  <i class="fa fa-plus"></i> Ajouter médicament
                </button>
              </div>
            </div>
          </div>
        </div>
      </t>
    </div>
  </t>
</templates>